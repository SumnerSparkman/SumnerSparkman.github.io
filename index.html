<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>QR Code Generator</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; background: #f9fafb; color: #111827; }
    .wrap { min-height: 100%; display: grid; place-items: center; padding: 24px; }
    .card { width: min(92vw, 720px); background: white; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); padding: 22px; }
    h1 { margin: 0 0 8px; font-size: clamp(1.25rem, 0.8rem + 2vw, 1.75rem); }
    p.sub { margin: 0 0 16px; color: #4b5563; }
    .row { display: grid; gap: 10px; grid-template-columns: 1fr; }
    @media (min-width: 640px) { .row.two { grid-template-columns: 1fr 1fr; } .row.three { grid-template-columns: 1fr 1fr 1fr; } }
    input[type="text"] { width: 100%; padding: 12px 14px; border: 1px solid #d1d5db; border-radius: 12px; font-size: 1rem; }
    .field { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 12px; }
    .field label { font-size: .9rem; color: #374151; white-space: nowrap; }
    .field input[type="color"] { width: 44px; height: 36px; border: none; padding: 0; background: none; }
    .field.range { gap: 14px; }
    .field output { min-width: 3ch; text-align: right; font-variant-numeric: tabular-nums; }
    input[type="range"] { width: 100%; }
    .qr-wrap { display: grid; place-items: center; padding: 18px; border: 1px dashed #e5e7eb; border-radius: 16px; margin-top: 16px; }
    #qrcode { display: grid; place-items: center; width: 100%; }
    .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
    button { cursor: pointer; padding: 12px 16px; border-radius: 12px; border: 1px solid #111827; background: #111827; color: white; font-weight: 600; }
    button.secondary { background: white; color: #111827; border-color: #d1d5db; }
  </style>
  <script src="./qrcode.min.js"></script>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>QR Code Generator</h1>
      <p class="sub">Enter text/URL, pick colors, and adjust rounded corners.</p>

      <div class="row">
        <input id="input" name="input" type="text" placeholder="example.com or https://example.com" />
      </div>

      <div class="row three" style="margin-top:10px">
        <div class="field">
          <label for="colorDark">QR color</label>
          <input id="colorDark" type="color" value="#000000" />
        </div>
        <div class="field">
          <label for="colorLight">Background</label>
          <input id="colorLight" type="color" value="#ffffff" />
        </div>
        <div class="field range">
          <label for="rounded">Roundedness</label>
          <input id="rounded" type="range" min="0" max="50" step="1" value="25" />
          <output id="roundedOut">25%</output>
        </div>
      </div>

      <div class="qr-wrap">
        <div id="qrcode" aria-label="QR code output" role="img"></div>
      </div>

      <div class="actions">
        <button id="download" class="secondary" type="button">Download PNG</button>
        <button id="copyurl" class="secondary" type="button">Copy input text</button>
        <button id="share" class="secondary" type="button">Share</button>
        <button id="permalink" class="secondary" type="button">Copy page permalink</button>
      </div>
    </section>
  </main>

  <script>
    (function(){
      const $ = (sel) => document.querySelector(sel);

      const inputEl = $('#input');
      const colorDarkEl = $('#colorDark');
      const colorLightEl = $('#colorLight');
      const roundedEl = $('#rounded');
      const roundedOut = $('#roundedOut');

      const dlBtn = $('#download');
      const copyBtn = $('#copyurl');
      const shareBtn = $('#share');
      const linkBtn = $('#permalink');

      let lastText = '';
      let lastColors = { dark: '', light: '' };
      let lastRounded = -1;

      // Load from query string: ?u=...&cd=#hex&cl=#hex&rs=0..50
      (function readParams(){
        const params = new URL(location.href).searchParams;
        const qUrl = params.get('u');
        const qCd = params.get('cd');
        const qCl = params.get('cl');
        const qRs = params.get('rs');

        if (qUrl) inputEl.value = decodeURIComponent(qUrl);
        if (qCd) colorDarkEl.value = qCd;
        if (qCl) colorLightEl.value = qCl;
        if (qRs && !Number.isNaN(parseInt(qRs, 10))) {
          const v = Math.max(0, Math.min(50, parseInt(qRs, 10)));
          roundedEl.value = String(v);
        }
        roundedOut.textContent = roundedEl.value + '%';
      })();

      function clearQR(){ $('#qrcode').innerHTML = ''; }

      function normalizeInput(raw){
        let v = (raw || '').trim();
        if (!v) return '';
        const looksLikeUrl = /^[^\s]+\.[^\s]+/.test(v) || /^localhost(:\d+)?(\/|$)/i.test(v);
        const hasScheme = /^[a-zA-Z][a-zA-Z0-9+.-]*:\/\//.test(v);
        if (looksLikeUrl && !hasScheme){
          const parts = v.split('/');
          const host = parts[0];
          const hasSub = host.split('.').length > 2 || host.toLowerCase().startsWith('www.');
          if (!hasSub) parts[0] = 'www.' + host;
          v = 'https://' + parts.join('/');
        }
        return v;
      }
      function makeQR(){
        const holder = document.querySelector('#qrcode');
        if (typeof QRCode === 'undefined'){
          holder.innerHTML = '<div style="color:#b91c1c; font-size:14px;">QR library failed to load.</div>';
          return;
        }

        const text = normalizeInput(document.querySelector('#input').value);
        const colorDark = document.querySelector('#colorDark').value || '#000000';
        const colorLight = document.querySelector('#colorLight').value || '#ffffff';
        const roundedPct = Math.max(0, Math.min(50, parseInt(document.querySelector('#rounded').value || '25', 10)));

        if (!text) { holder.innerHTML = ''; lastText=''; lastColors={dark:'', light:''}; lastRounded=-1; return; }
        if (text === lastText && colorDark === lastColors.dark && colorLight === lastColors.light && roundedPct === lastRounded) return;

        lastText = text; lastColors = {dark: colorDark, light: colorLight}; lastRounded = roundedPct;
        holder.innerHTML = '';

        // Encode only
        const tmp = new QRCode(document.createElement('div'), {
          text, width: 256, height: 256, colorDark, colorLight, correctLevel: QRCode.CorrectLevel.M
        });
        const qr = tmp._oQRCode;
        const n = qr.getModuleCount();

        // Snap to integer grid to avoid hairlines
        const maxSize = Math.min(window.innerWidth * 0.8, 512);
        const cell = Math.max(1, Math.floor(maxSize / n));
        const vbSize = cell * n;
        const r = cell * (roundedPct / 100);

        const NS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(NS, 'svg');
        svg.setAttribute('viewBox', `0 0 ${vbSize} ${vbSize}`);
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '100%');
        svg.setAttribute('shape-rendering', 'geometricPrecision');

        const bg = document.createElementNS(NS, 'rect');
        bg.setAttribute('x', '0'); bg.setAttribute('y', '0');
        bg.setAttribute('width', vbSize); bg.setAttribute('height', vbSize);
        bg.setAttribute('fill', colorLight);
        svg.appendChild(bg);

        const isDark = (r0, c0) => (r0 >= 0 && c0 >= 0 && r0 < n && c0 < n) ? qr.isDark(r0, c0) : false;

        // Rounded-rect path segment (per-corner radii)
        function roundedPath(x, y, w, h, rtl, rtr, rbr, rbl){
          rtl = Math.min(rtl, w/2, h/2);
          rtr = Math.min(rtr, w/2, h/2);
          rbr = Math.min(rbr, w/2, h/2);
          rbl = Math.min(rbl, w/2, h/2);
          return [
            `M${x+rtl},${y}`,
            `H${x+w-rtr}`, rtr?`Q${x+w},${y} ${x+w},${y+rtr}`:`V${y}`,
            `V${y+h-rbr}`, rbr?`Q${x+w},${y+h} ${x+w-rbr},${y+h}`:`H${x+w}`,
            `H${x+rbl}`,   rbl?`Q${x},${y+h} ${x},${y+h-rbl}`:`V${y+h}`,
            `V${y+rtl}`,   rtl?`Q${x},${y} ${x+rtl},${y}`:`H${x}`,
            'Z'
          ].join(' ');
        }

        // Build ONE combined path for all dark modules (outer rounding only)
        let dDark = '';
        for (let row = 0; row < n; row++) {
          for (let col = 0; col < n; col++) {
            if (!qr.isDark(row, col)) continue;

            const x = col * cell, y = row * cell;
            const up = isDark(row-1, col), down = isDark(row+1, col);
            const left = isDark(row, col-1), right = isDark(row, col+1);

            const rtl = (!up && !left)  ? r : 0;
            const rtr = (!up && !right) ? r : 0;
            const rbr = (!down && !right)? r : 0;
            const rbl = (!down && !left) ? r : 0;

            dDark += roundedPath(x, y, cell, cell, rtl, rtr, rbr, rbl) + ' ';
          }
        }

        const darkPath = document.createElementNS(NS, 'path');
        darkPath.setAttribute('d', dDark.trim());
        darkPath.setAttribute('fill', colorDark);
        svg.appendChild(darkPath);

        // --- NEW: inner-corner roundings (cutouts) -------------------------------
        // For each LIGHT cell, if it has two orthogonal DARK neighbors, carve a quarter-circle
        // out of the dark shape by overlaying a wedge filled with the background color.
        let dCut = '';

        function addTL(x,y){ // top-left corner of the light cell
          dCut += `M${x},${y} L${x},${y+r} Q${x},${y} ${x+r},${y} L${x},${y} Z `;
        }
        function addTR(x,y, w){ // top-right corner (x+w,y)
          const xr = x + w;
          dCut += `M${xr},${y} L${xr - r},${y} Q${xr},${y} ${xr},${y + r} L${xr},${y} Z `;
        }
        function addBR(x,y, w,h){ // bottom-right (x+w,y+h)
          const xr = x + w, yb = y + h;
          dCut += `M${xr},${yb} L${xr},${yb - r} Q${xr},${yb} ${xr - r},${yb} L${xr},${yb} Z `;
        }
        function addBL(x,y, h){ // bottom-left (x,y+h)
          const yb = y + h;
          dCut += `M${x},${yb} L${x + r},${yb} Q${x},${yb} ${x},${yb - r} L${x},${yb} Z `;
        }

        for (let row = 0; row < n; row++) {
          for (let col = 0; col < n; col++) {
            if (isDark(row, col)) continue; // only consider light cells

            const x = col * cell, y = row * cell;

            if (isDark(row-1, col) && isDark(row, col-1)) addTL(x, y);
            if (isDark(row-1, col) && isDark(row, col+1)) addTR(x, y, cell);
            if (isDark(row+1, col) && isDark(row, col+1)) addBR(x, y, cell, cell);
            if (isDark(row+1, col) && isDark(row, col-1)) addBL(x, y, cell);
          }
        }

        if (dCut) {
          const cut = document.createElementNS(NS, 'path');
          cut.setAttribute('d', dCut.trim());
          cut.setAttribute('fill', colorLight);       // same as background
          svg.appendChild(cut);
        }
        // ------------------------------------------------------------------------

        holder.appendChild(svg);
        holder.style.padding = '8px';
      }
      
      // Events
      ['input','change','paste','blur','keyup'].forEach(ev =>
        inputEl.addEventListener(ev, () => { lastText = ''; makeQR(); })
      );
      [colorDarkEl, colorLightEl].forEach(el =>
        el.addEventListener('input', () => { lastText = ''; makeQR(); })
      );
      roundedEl.addEventListener('input', () => {
        roundedOut.textContent = roundedEl.value + '%';
        lastText = ''; makeQR();
      });

      makeQR();

      // PNG download: rasterize the current SVG for crisp export
      dlBtn.addEventListener('click', () => {
        const svg = document.querySelector('#qrcode svg');
        if (!svg) return alert('Generate a QR first.');

        const xml = new XMLSerializer().serializeToString(svg);
        const svgBlob = new Blob([xml], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);

        const img = new Image();
        img.onload = () => {
          const px = Math.round(svg.viewBox.baseVal.width || 512);
          const scale = Math.max(1, Math.floor(window.devicePixelRatio || 1));
          const canvas = document.createElement('canvas');
          canvas.width = px * scale;
          canvas.height = px * scale;
          const ctx = canvas.getContext('2d');
          ctx.scale(scale, scale);
          ctx.drawImage(img, 0, 0, px, px);
          URL.revokeObjectURL(url);

          const link = document.createElement('a');
          link.download = 'qr.png';
          link.href = canvas.toDataURL('image/png');
          link.click();
        };
        img.onerror = () => { URL.revokeObjectURL(url); alert('Unable to render image.'); };
        img.src = url;
      });

      copyBtn.addEventListener('click', async () => {
        const v = normalizeInput(inputEl.value);
        if (!v) return alert('Nothing to copy.');
        await navigator.clipboard.writeText(v);
        copyBtn.textContent = 'Copied!';
        setTimeout(() => copyBtn.textContent = 'Copy input text', 1200);
      });

      function permalink(){
        const url = new URL(location.href);
        const v = normalizeInput(inputEl.value);
        const cd = colorDarkEl.value || '#000000';
        const cl = colorLightEl.value || '#ffffff';
        const rs = Math.max(0, Math.min(50, parseInt(roundedEl.value || '25', 10)));
        const qs = [];
        if (v) qs.push('u=' + encodeURIComponent(v));
        if (cd) qs.push('cd=' + encodeURIComponent(cd));
        if (cl) qs.push('cl=' + encodeURIComponent(cl));
        qs.push('rs=' + rs);
        url.search = qs.length ? '?' + qs.join('&') : '';
        return url.toString();
      }

      shareBtn.addEventListener('click', async () => {
        try {
          const url = permalink();
          if (navigator.share) {
            await navigator.share({ title: 'QR Code', url });
          } else {
            await navigator.clipboard.writeText(url);
            alert('Link copied to clipboard.');
          }
        } catch { alert('Unable to share.'); }
      });

      linkBtn.addEventListener('click', async () => {
        await navigator.clipboard.writeText(permalink());
        linkBtn.textContent = 'Permalink copied!';
        setTimeout(() => linkBtn.textContent = 'Copy page permalink', 1200);
      });

      window.addEventListener('resize', () => { lastText = ''; makeQR(); });
    })();
  </script>
</body>
</html>
